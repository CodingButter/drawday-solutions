// Firebase imports removed - using Directus for authentication
// import { User } from 'firebase/auth';
// import { db } from './firebase-config';
// import {
//   doc,
//   getDoc,
//   setDoc,
//   serverTimestamp,
// } from 'firebase/firestore';
import { storage } from '@raffle-spinner/storage';
import type { SpinnerSettings, ColumnMapping, SavedMapping } from '@raffle-spinner/types';

interface FirebaseUserSettings {
  userId: string;
  spinner: SpinnerSettings;
  theme: {
    spinnerStyle: {
      nameColor: string;
      ticketColor: string;
      backgroundColor: string;
      canvasBackground: string;
      borderColor: string;
      highlightColor: string;
      nameSize: string;
      ticketSize: string;
      fontFamily: string;
      topShadowOpacity: number;
      bottomShadowOpacity: number;
      shadowSize: number;
      shadowColor: string;
    };
    branding: {
      logoImage?: string;
      logoPosition: 'left' | 'center' | 'right';
      bannerImage?: string;
      companyName?: string;
      showCompanyName: boolean;
    };
  };
  columnMapping?: ColumnMapping;
  savedMappings?: SavedMapping[];
  updatedAt?: unknown;
}

/**
 * Sync local settings with Firebase when user logs in
 */
export const syncSettingsOnLogin = async (user: User): Promise<void> => {
  try {
    console.log('Syncing settings for user:', user.uid);
    
    // Get settings from Firebase
    const settingsRef = doc(db, 'userSettings', user.uid);
    const settingsSnap = await getDoc(settingsRef);
    
    if (settingsSnap.exists()) {
      const firebaseSettings = settingsSnap.data() as FirebaseUserSettings;
      
      // Sync spinner settings to local storage
      if (firebaseSettings.spinner) {
        await storage.saveSettings(firebaseSettings.spinner);
      }
      
      // Sync theme/branding to local storage
      if (firebaseSettings.theme) {
        const theme = {
          colors: {
            primary: '#007BFF',
            secondary: '#FF1493',
            accent: '#FFD700',
            background: '#09090b',
            foreground: '#fafafa',
            card: '#09090b',
            cardForeground: '#fafafa',
            winner: '#FFD700',
            winnerGlow: '#FFD700',
          },
          spinnerStyle: firebaseSettings.theme.spinnerStyle,
          branding: firebaseSettings.theme.branding,
        };
        
        // Store theme in localStorage for compatibility with ThemeContext
        if (typeof window !== 'undefined') {
          localStorage.setItem('theme', JSON.stringify(theme));
        }
      }
      
      // Sync column mapping
      if (firebaseSettings.columnMapping) {
        await storage.saveColumnMapping(firebaseSettings.columnMapping);
      }
      
      // Sync saved mappings
      if (firebaseSettings.savedMappings) {
        // Store saved mappings in localStorage for now
        // TODO: Add proper saved mappings support to storage adapter
        if (typeof window !== 'undefined') {
          localStorage.setItem('savedMappings', JSON.stringify(firebaseSettings.savedMappings));
        }
      }
      
      console.log('Settings synced successfully from Firebase');
    } else {
      console.log('No settings found in Firebase for user, using local settings');
      
      // Optionally, upload local settings to Firebase if they don't exist
      const localSettings = await storage.getSettings();
      const localMapping = await storage.getColumnMapping();
      const localMappings: SavedMapping[] = [];
      
      const newSettings: FirebaseUserSettings = {
        userId: user.uid,
        spinner: localSettings,
        theme: {
          spinnerStyle: {
            nameColor: '#ffffff',
            ticketColor: '#a0a0a0',
            backgroundColor: '#1a1a1a',
            canvasBackground: '#0a0a0a',
            borderColor: '#333333',
            highlightColor: '#ffd700',
            nameSize: 'large',
            ticketSize: 'medium',
            fontFamily: 'system-ui, -apple-system, sans-serif',
            topShadowOpacity: 0.8,
            bottomShadowOpacity: 0.8,
            shadowSize: 60,
            shadowColor: '#000000',
          },
          branding: {
            logoPosition: 'center',
            showCompanyName: true,
          },
        },
        columnMapping: localMapping || undefined,
        savedMappings: localMappings.length > 0 ? localMappings : undefined,
        updatedAt: serverTimestamp(),
      };
      
      await setDoc(settingsRef, newSettings);
      console.log('Local settings uploaded to Firebase');
    }
  } catch (error) {
    console.error('Error syncing settings:', error);
    // Don't throw - continue with local settings if sync fails
  }
};

/**
 * Upload local settings changes to Firebase
 */
export const uploadSettingsToFirebase = async (user: User): Promise<void> => {
  try {
    const localSettings = await storage.getSettings();
    const localMapping = await storage.getColumnMapping();
    const localMappings: SavedMapping[] = [];
    
    const settingsRef = doc(db, 'userSettings', user.uid);
    
    // Get existing theme from localStorage
    const theme = {
      spinnerStyle: {
        nameColor: '#ffffff',
        ticketColor: '#a0a0a0',
        backgroundColor: '#1a1a1a',
        canvasBackground: '#0a0a0a',
        borderColor: '#333333',
        highlightColor: '#ffd700',
        nameSize: 'large',
        ticketSize: 'medium',
        fontFamily: 'system-ui, -apple-system, sans-serif',
        topShadowOpacity: 0.8,
        bottomShadowOpacity: 0.8,
        shadowSize: 60,
        shadowColor: '#000000',
      },
      branding: {
        logoPosition: 'center' as const,
        showCompanyName: true,
      },
    };
    
    if (typeof window !== 'undefined') {
      const storedTheme = localStorage.getItem('theme');
      if (storedTheme) {
        try {
          const parsed = JSON.parse(storedTheme);
          if (parsed.spinnerStyle) theme.spinnerStyle = parsed.spinnerStyle;
          if (parsed.branding) theme.branding = parsed.branding;
        } catch (e) {
          console.error('Failed to parse theme from localStorage:', e);
        }
      }
    }
    
    await setDoc(settingsRef, {
      userId: user.uid,
      spinner: localSettings,
      theme,
      columnMapping: localMapping || undefined,
      savedMappings: localMappings.length > 0 ? localMappings : undefined,
      updatedAt: serverTimestamp(),
    }, { merge: true });
    
    console.log('Settings uploaded to Firebase');
  } catch (error) {
    console.error('Error uploading settings to Firebase:', error);
  }
};